!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"https://shadow.elemecdn.com/lib/crystal-sdk@0.2.7/==typeof define&&define.amd?define(t):e.Crystal=t()}(this,function(){"use strict";function e(e,t){return t={exports:{}},e(t,t.exports),t.exports}var t=e(function(e){function t(e){if(e)return n(e)}function n(e){for(var n in t.prototype)e[n]=t.prototype[n];return e}e.exports=t,t.prototype.on=t.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this},t.prototype.once=function(e,t){function n(){this.off(e,n),t.apply(this,arguments)}return n.fn=t,this.on(e,n),this},t.prototype.off=t.prototype.removeListener=t.prototype.removeAllListeners=t.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n=this._callbacks["$"+e];if(!n)return this;if(1==arguments.length)return delete this._callbacks["$"+e],this;for(var o,r=0;r<n.length;r++)if((o=n[r])===t||o.fn===t){n.splice(r,1);break}return this},t.prototype.emit=function(e){var t=this;this._callbacks=this._callbacks||{};var n=[].slice.call(arguments,1),o=this._callbacks["$"+e];if(o)for(var r=0,i=(o=o.slice(0)).length;r<i;++r)o[r].apply(t,n);return this},t.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]},t.prototype.hasListeners=function(e){return!!this.listeners(e).length}}),n=e(function(e){function t(e){var t=arguments;e=Object(e);for(var n=1;n<arguments.length;n++){var o=t[n];if(null!=o)for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(e[r]=o[r])}return e}function n(e){return null!==e&&"object"==typeof e}function o(e){return Object.prototype.toString.call(e)===x}function r(){}function i(e){return w.indexOf(e)>-1}function s(e,t,o,r){var i="color: "+e;r?console.log("%c [ace:debug:"+t+"] "+o,i,r):n(o)?console.log("%c [ace:debug:"+t+"]",i,o):console.log("%c [ace:debug:"+t+"] "+o,i)}function a(){var e=(new Date).getTime();return window.performance&&"function"==typeof window.performance.now&&(e+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:3&n|8).toString(16)})}function c(e){return void 0===e&&(e={}),new Headers(t({"Content-Type":"application/json;charset=UTF-8",Accept:"application/json, text/plain, */*"},e))}function u(e,t,n,o){return void 0===o&&(o={}),{id:a(),metas:e.metas,ncp:e.ncp,service:t,method:n,params:o}}function p(e,t,n){var o=new O(t.id,{type:"COMMON",code:"Connection error",message:"network timeout..."}),r=new O(t.id,{type:"CANCELED",code:"Request cancaled",message:"http request canceled!"}),i=null,s=new Promise(function(s,a){setTimeout(a.bind(void 0,o),n),fetch(e,t).then(s,a),i=function(){a(r)}});return s.abort=i,s}function f(e,t){return{method:I,mode:E,headers:e,body:JSON.stringify(t),id:t.id}}function l(e,t,n,o){R.emit("removeRequest",e);var r=N("mock");return r[e].error?h(new O(t.id,r[e].error),n,e,o):h(new j(t.id,r[e].data),n,e,o)}function h(e,n,r,i){if(e.error||!o(e)){var s=o(e)?t({},e.error,{method:r,url:i}):t({},{message:e},{method:r,url:i});n.reject(s),R.emit("onError",s),R.emit(i+"__error",s),C.error(r,s)}else n.resolve(e.result),C.res(r,e.result)}function d(e){var n=e.config;void 0===n&&(n={});var o=e.method;void 0===o&&(o="");var i=e.params;void 0===i&&(i={});var s=e.promiseObj;void 0===s&&(s={resolve:r,reject:r});var a=o.split("."),d=u.apply(void 0,[n].concat(a,[i])),m=f(c(n.addRequestIdInHeader?t(n.headers||{},{"X-Eleme-RequestID":d.id}):n.headers),d),v=n.debug&&n.debug.mock,g=N("mock");return v&&g[o]?void l(o,m,s,n.uri):(e.fetchPromise=p(n.uri+"?method="+o,m,n.timeout),void e.fetchPromise.then(function(e){return C.req(o,i),R.emit("removeRequest"https://shadow.elemecdn.com/lib/crystal-sdk@0.2.7/,o),e.ok&&e.json?e.json().then(function(e){h(e,s,o,n.uri)}):void(e.ok||h(e.status+" : "+e.statusText,s,o,n.uri))}).catch(function(e){R.emit("removeRequest",o),h(e,s,o,n.uri)}))}function m(e,t){if(!e)throw new Error("[ace] "+t)}function v(e,n){return m(o(n),"config must be plain Object!"),Object.keys(n).forEach(function(r){m(T.indexOf(r)>-1,"config key must match 'metas', 'headers', 'uri', 'debug', 'ncp', 'secure',\n      'timeout', 'throttle' or 'addRequestIdInHeader'"),o(n[r])&&(e[r]=e[r]||{},n[r]=t({},e[r],n[r]))}),t({},e,n)}function g(e){this._config=this._config?v(this._config,e):v(P,e),this._config.uri=this._config.secure?this._config.uri.replace(/http:/,"https:"):this._config.uri}var y=function(){this._events={}};y.prototype.on=function(e,t){this._events[e]=this._events[e]||[],this._events[e].push(t)},y.prototype.off=function(e,t){if(this._events[e]=this._events[e]||[],t){var n=this._events[e].indexOf(t);n>-1&&this._events[e].splice(n,1)}else this._events[e]=[]},y.prototype.emit=function(e){var t=this,n=this._events[e];if(n&&n.length){var o=Array.prototype.slice.call(arguments,1);n.forEach(function(e){e.apply(t,o)})}};var b={},k={addMock:function(e,t,n){b[e]={data:t,error:n}},getMocks:function(){return b}},x="[object Object]",_=window.localStorage.getItem("debug"),w=_?_.split(","):[],M={req:"#00994c",res:"#0091ea",error:"#ff5d51"},C={error:function(e,t){(i("ace.error")||i("ace.*"))&&s(M.error,"error",e,t)},req:function(e,t){(i("https://shadow.elemecdn.com/lib/crystal-sdk@0.2.7/ace.req")||i("ace.*"))&&s(M.req,"req",e,t)},res:function(e,t){(i("https://shadow.elemecdn.com/lib/crystal-sdk@0.2.7/ace.res")||i("ace.*"))&&s(M.res,"res",e,t)}},O=function(e,n){this.id=e,this.type="invoke.response",this.error=t({type:"COMMON",code:"Mock Error",message:"Mock Message"},n),this.result=null};O.prototype.toString=function(){return JSON.stringify(this)};var j=function(e,t){this.id=e,this.type="invoke.response",this.result=t,this.error=null};j.prototype.toString=function(){return JSON.stringify(this)};var q=[],I="post",E="cors",N=function(e){var t=Object.create(null);return function(n){return t[n]||(t[n]=e(n))}}(function(){return k.getMocks()}),S=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.add=function(e){var t=e.config&&e.config.throttle;q.push(e),q.length<=t&&d(e)},t.remove=function(e){var t=q.map(function(e){return e.method}).indexOf(e);if(t>-1){q.splice(t,1);var n=q.filter(function(e){return!e.fetchPromise});n.length&&d(n.shift())}},t.cancel=function(e){q.filter(function(t){return t.config&&t.config.uri===e&&t.fetchPromise}).forEach(function(e){e.fetchPromise.abort()}),q=q.filter(function(t){return t.config&&t.config.uri!==e})},t.cancelMethod=function(e,t){q.filter(function(n){return n.config&&n.config.uri===e&&n.method===t&&n.fetchPromise}).forEach(function(e){e.fetchPromise.abort()})},t}(y),R=new S;R.on("addRequest",S.add.bind(S)),R.on("removeRequest",S.remove.bind(S)),R.on("requestsCacheCancel",S.cancel.bind(S)),R.on("requestCancel",S.cancelMethod.bind(S));var T=["metas","headers","uri","debug","ncp","secure","timeout","throttle","addRequestIdInHeader"],L={},P={ncp:"2.0.0",secure:!0,debug:{mock:!1},timeout:15e3,throttle:50,addRequestIdInHeader:!0};m(window.fetch,"your browser doesn't support fetch, please add a fetch polyfill, read compatibility in README.md for detail!");var U=function(e){var t=o(e)?e:{uri:e};g.bind(this)(t),L[e.uri]=this};U.config=function(e){P=v(P,e)},U.addMock=function(e,t,n){k.addMock(e,t,n)},U.onError=function(e){R.on("onError",e)},U.getModules=function(){return L},U.prototype.config=function(e){g.bind(this)(e)},U.prototype.onError=function(e){var t=this._config;R.on(t.uri+"__error",e)},U.prototype.invoke=function(e,t,n){void 0===n&&(n={});var o={},r=v(this._config,n),i=new Promise(function(n,i){o={config:r,method:e,params:t,promiseObj:{resolve:n,reject:i}}});return R.emit("addRequest",o),i},U.prototype.cancel=function(){var e=this._config;R.emit("requestsCacheCancel",e.uri)},U.prototype.cancelMethod=function(e){var t=this._config;R.emit("requestCancel",t.uri,e)},e.exports=U}),o={development:"https://message-api.alpha.elenet.me/invoke/",alpha:"https://message-api.alpha.elenet.me/invoke/",beta:"http://xy-api.beta.elenet.me/message/invoke/",alta:"https://message-api.alta.elenet.me/invoke/",altb:"https://message-api.altb.elenet.me/invoke/",ar:"https://message-api.ar.elenet.me/invoke/",production:"https://message-api.ele.me/invoke/"},r={development:"https://crystal-message-test.faas.elenet.me",alpha:"https://crystal-message-test.faas.elenet.me",beta:"https://crystal-message-test-beta.faas.elenet.me",alta:"https://crystal-message.faas.alta.elenet.me",altb:"https://crystal-message.faas.altb.elenet.me",ar:"https://crystal-message.faas.ar.elenet.me",production:"https://crystal-message.faas.ele.me"},i=function(e){var t={uri:o[e.env||"production"],metas:{appName:"crystal-sdk",appVersion:"1.0.0",token:e.token,acctType:e.accountType,app:e.app}};this.service=new n(t)};i.prototype.getMessageList=function(e,t,n,o){return this.service.invoke("MessageService.getMessageList",{limit:e,offset:t,tab:n,readStat:o})},i.prototype.pollingNotify=function(){return this.service.invoke("MessageService.pollingNotify")},i.prototype.getUnreadCount=function(e){return this.service.invoke("MessageService.getUnReadCount",{tabs:e})},i.prototype.setReadStatus=function(e){return this.service.invoke("MessageService.setReadStatus",{messageId:e})},i.prototype.setNotified=function(e){return this.service.invoke("MessageService.setNotified",{messageId:e})};var s,a,c;return function(e){function t(t){var n=this;t&&t.app&&t.token||console.error("config must contain 'app', 'token', 'accountType' and 'messageTypes'!"),e.call(this),this.options=t,s=new i(t),window.addEventListener("message",function(t){var o=t.data;"crystal.event"===o.type&&e.prototype.emit.call(n,o.eventName,o.data)})}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype.on=function(t,n){var o=this;"https://shadow.elemecdn.com/lib/crystal-sdk@0.2.7/message.new"!==t||a||(s.pollingNotify().then(function(e){window.postMessage({type:"crystal.event",eventName:"https://shadow.elemecdn.com/lib/crystal-sdk@0.2.7/message.new",data:e},"*")}),a=setInterval(function(){s.pollingNotify().then(function(e){window.postMessage({type:"crystal.event",eventName:"https://shadow.elemecdn.com/lib/crystal-sdk@0.2.7/message.new",data:e},"*")})},12e5)),"message.unreadCount"!==t||c||(s.getUnreadCount(this.options.messageTypes).then(function(e){window.postMessage({type:"crystal.event",eventName:"message.unreadCount",data:e},"*")}),c=setInterval(function(){s.getUnreadCount(o.options.messageTypes).then(function(e){window.postMessage({type:"crystal.event",eventName:"message.unreadCount",data:e},"*")})},12e5)),e.prototype.on.call(this,t,n)},t.prototype.off=function(t,n){"https://shadow.elemecdn.com/lib/crystal-sdk@0.2.7/message.new"===t&&a&&(clearInterval(a),a=null),"message.unreadCount"===t&&c&&(clearInterval(c),c=null),e.prototype.off.call(this,t,n)},t.prototype.getMessageList=function(e,t){var n=e.limit,o=e.offset,r=e.tab,i=e.readStat;s.getMessageList(n,o,r,i).then(function(e){return t(null,e)}).catch(function(e){return t(e,null)})},t.prototype.getUnreadCount=function(e){s.getUnreadCount(this.options.messageTypes).then(function(t){return e(null,t)}).catch(function(t){return e(t,null)})},t.prototype.setReaded=function(e,t){s.setReadStatus(e).then(function(e){return t(null,!0)}).catch(function(e){return t(e,!1)})},t.prototype.setNotified=function(e,t){s.setNotified(e).then(function(e){return t(null,!0)}).catch(function(e){return t(e,!1)})},t.prototype.getInboxUrl=function(e){var t=Object.assign({},this.options,{activeType:e}),n=Object.keys(t).reduce(function(e,n){return"env"!==n&&t[n]&&e.push(n+"="+t[n]),e},[]).join("&");return r[this.options.env||"production"]+"?"+n},t.prototype.getInbox=function(){var e=document.createElement("iframe"),t=this.getInboxUrl();return e.src=t,e},t.prototype.createInbox=function(e){var t=this.getInbox();e instanceof HTMLElement?e.appendChild(t):document.querySelector(e).appendChild(t)},t}(t)});
